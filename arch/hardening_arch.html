<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hardening Arch Linux - privacy-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">privacy-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hardening-arch-linux"><a class="header" href="#hardening-arch-linux">Hardening Arch Linux</a></h1>
<p>In this section I will assume you're using GRUB. In the future I plan on adding
a systemd-boot section as it is more minimalist and therefore has a smaller
attack surface with fewer lines of code to exploit.</p>
<h2 id="hardening-the-kernel"><a class="header" href="#hardening-the-kernel">Hardening the Kernel</a></h2>
<p>You can use the <code>linux-hardened</code> kernel to have a kernel that prioritizes
security over anything else:</p>
<pre><code class="language-bash">sudo pacman -S linux-hardened linux-hardened-headers
</code></pre>
<p>Edit your <code>/etc/default/grub</code>:</p>
<pre><code class="language-bash">GRUB_DEFAULT=saved
GRUB_SAVEDEFAULT=true
GRUB_DISABLE_SUBMENU=y
</code></pre>
<ul>
<li>This enables you to choose from the available kernels at boot and stays on the
kernel you chose last.</li>
</ul>
<p>Make grub aware of the new kernel:</p>
<pre><code class="language-bash">sudo grub-mkconfig -o /boot/grub/grub.cfg
</code></pre>
<p>Generate the initramfs:</p>
<pre><code class="language-bash">sudo mkinitcpio -p linux-hardened
</code></pre>
<p>Reboot and choose <code>linux-hardened</code>.</p>
<hr />
<h2 id="hardening-your-current-kernel"><a class="header" href="#hardening-your-current-kernel">Hardening your current Kernel</a></h2>
<p>Sometimes <code>linux-hardened</code> just won't work on your system without some serious
digging. You can harden your current kernel, or even better would be to harden
the Long-Term Support (LTS) kernel.</p>
<p>Create a file <code>/etc/sysctl.d/99-custom.conf</code>, since files are read in
lexicographical order this file will be read last, allowing it to override any
settings from earlier files.</p>
<p>To check if a parameter is already set:</p>
<pre><code class="language-bash">sysctl fs.protected_symlinks
sysctl -a | grep fs.protected
</code></pre>
<p>To list all parameters:</p>
<pre><code class="language-bash">sysctl -a &gt; params.txt
</code></pre>
<ul>
<li>
<p><code>1</code> typically means enable</p>
</li>
<li>
<p><code>0</code> typically means disable</p>
</li>
</ul>
<p>Example, both of these were the default in the zen-kernel:</p>
<pre><code class="language-bash"># 99-custom.conf
# prevent hardlink misuse
fs.protected_hardlinks = 1
# prevent symlink misuse
fs.protected_symlinks = 1
</code></pre>
<p>Apply the changes immediately:</p>
<pre><code class="language-bash">sudo sysctl --system
</code></pre>
<pre><code class="language-bash">sudo pacman -S kernel-hardening-checker
</code></pre>
<p>While in the same directory as the <code>params.txt</code> that we created earlier, run:</p>
<pre><code class="language-bash">kernel-hardening-checker -l /proc/cmdline -c /proc/config.gz -s ./params.txt
</code></pre>
<p>Only the warnings listed with <code>| sysctl |</code> can be edited with the above method.</p>
<p>Example <code>99-custom.conf</code> with some settings to prevent breakage:</p>
<details>
<summary> ✔️ Click to Expand `99-custom.conf` example </summary>
<blockquote>
<p>❗️ NOTE: Always do your own research, many of these settings come from
recommendations from the kernel-hardening-checker as well as
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html">madaidans insecurities Linux Hardening guid</a>.</p>
</blockquote>
<pre><code class="language-conf">fs.suid_dumpable = 0

# Fix "FAIL: 0", recommended is 2
net.core.bpf_jit_harden = 2

# Fix "FAIL: 10000", recommended is 100
kernel.oops_limit = 100

# Fix "FAIL: 0", recommended is 100
kernel.warn_limit = 100


 # Kernel self-protection
# SysRq exposes a lot of potentially dangerous debugging functionality to unprivileged users
# 4 makes it so a user can only use the secure attention key. A value of 0 would disable completely
kernel.sysrq = 4

# Fix "FAIL: 2", recommended is 3
kernel.perf_event_paranoid = 3

# Fix "FAIL: 1", recommended is 0
dev.tty.ldisc_autoload = 1

# Fix "FAIL: 0", recommended is 2
kernel.kptr_restrict = 2

kernel.dmesg_restrict = 1

# Fix "FAIL: 61175", recommended is 0
user.max_user_namespaces = 15000

# Fix "FAIL: 0", recommended is 1
kernel.kexec_load_disabled = 1

# Fix "FAIL: 2", recommended is 1
kernel.unprivileged_bpf_disabled = 1

# Fix "FAIL: 1", recommended is 0
vm.unprivileged_userfaultfd = 0

# Fix "FAIL: 0", recommended is 1
kernel.modules_disabled = 0

# Fix "FAIL: 0", recommended is 2
# restricts access to async I/O and prevents spawning new shells
kernel.io_uring_disabled = 0

# Fix "FAIL: 16", recommended is 0
kernel.sysrq = 0

# Fix "FAIL: 1", recommended is 2
fs.protected_fifos = 2

# Fix "FAIL: 1", recommended is 2
fs.protected_regular = 2

# Fix "FAIL: 2", recommended is 0
fs.suid_dumpable = 0

# Fix "FAIL: 1", recommended is 3
kernel.yama.ptrace_scope = 2

# Fix "FAIL: 28", recommended is 32
vm.mmap_rnd_bits = 32

# Fix "FAIL: 8", recommended is 16
vm.mmap_rnd_compat_bits = 16

# Network
# protect against SYN flood attacks (denial of service attack)
net.ipv4.tcp_syncookies = 1
# protection against TIME-WAIT assassination
net.ipv4.tcp_rfc1337 = 1
# enable source validation of packets received (prevents IP spoofing)
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1

net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
# Protect against IP spoofing
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# prevent man-in-the-middle attacks
net.ipv4.icmp_echo_ignore_all = 1

# ignore ICMP request, helps avoid Smurf attacks
net.ipv4.conf.all.forwarding = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0
# Reverse path filtering causes the kernel to do source validation of
net.ipv6.conf.all.forwarding = 0
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

## TCP hardening
# Prevent bogus ICMP errors from filling up logs.
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Disable TCP SACK
net.ipv4.tcp_sack = 0
net.ipv4.tcp_dsack = 0
net.ipv4.tcp_fack = 0

# Userspace
# restrict usage of ptrace
kernel.yama.ptrace_scope = 2

# ASLR memory protection (64-bit systems)
vm.mmap_rnd_bits = 32
vm.mmap_rnd_compat_bits = 16

# only permit symlinks to be followed when outside of a world-writable sticky directory
fs.protected_symlinks = 1
fs.protected_hardlinks = 1
# Prevent creating files in potentially attacker-controlled environments
fs.protected_fifos = 2
fs.protected_regular = 2

# Randomize memory
kernel.randomize_va_space = 2
# Exec Shield (Stack protection)
kernel.exec-shield = 1

## TCP optimization
# TCP Fast Open is a TCP extension that reduces network latency by packing
# data in the sender’s initial TCP SYN. Setting 3 = enable TCP Fast Open for
# both incoming and outgoing connections:
net.ipv4.tcp_fastopen = 3
# Bufferbloat mitigations + slight improvement in throughput &amp; latency
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = cake
</code></pre>
</details>
<h2 id="firewall"><a class="header" href="#firewall">Firewall</a></h2>
<p>Flush existing iptables Rules &amp; Disable iptables:</p>
<blockquote>
<p>⚠️ Warning: Flushing rules will remove all existing firewall configurations.
Ensure no critical services are running, or review existing rules with
<code>iptables -L -v -n</code> and <code>ip6tables -L -v -n</code> before proceeding.</p>
</blockquote>
<pre><code class="language-bash">sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo ip6tables -F
sudo ip6tables -X

sudo systemctl disable iptables.service
sudo systemctl disable ip6tables.service
sudo systemctl stop iptables.service
sudo systemctl stop ip6tables.service
</code></pre>
<p><strong>Install and enable nftables</strong>:</p>
<pre><code class="language-bash">sudo pacman -S nftables
sudo systemctl enable nftables.service
sudo systemctl start nftables.service
</code></pre>
<p>Create nftables ruleset:</p>
<pre><code class="language-bash">#!/usr/sbin/nft -f

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback
        iif "lo" accept

        # Accept established and related connections
        ct state established,related accept

        ip protocol icmp accept
        # Allow ICMPv6
        ip6 nexthdr icmpv6 accept

        # Allow SSH (port 22)
        tcp dport 22 ct state new accept

        # Allow HTTP and HTTPS (ports 80 and 443)
        tcp dport {80,443} ct state new accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    chain output {
        type filter hook output priority 0; policy accept;

        # Allow DNS queries
        udp dport 53 accept
        tcp dport 53 accept
    }
}
</code></pre>
<blockquote>
<p>❗️ If you don't use SSH or host a web server or any service, don't allow SSH
and HTTP/HTTPS.</p>
</blockquote>
<p>Load and test the rules:</p>
<pre><code class="language-bash">sudo nft -f /etc/nftables.conf
</code></pre>
<pre><code class="language-bash">sudo nft list ruleset
</code></pre>
<hr />
<h2 id="ssh-keygen"><a class="header" href="#ssh-keygen">ssh-keygen</a></h2>
<p>The <code>ed25519</code> algorithm is significantly faster and more secure when compared to
<code>RSA</code>. You can also specify the key derivation function (KDF) rounds to
strengthen protection even more.</p>
<p>For example, to generate a strong key for MdBook:</p>
<pre><code class="language-bash">ssh-keygen -t ed25519 -a 32
</code></pre>
<p>Or more specifically:</p>
<pre><code class="language-bash">ssh-keygen -t ed25519 -a 32 -f ~/.ssh/id_ed25519_github_$(date +%Y-%m-%d) -C "SSH Key for GitHub"
</code></pre>
<ul>
<li>
<p><code>-t</code> is for type</p>
</li>
<li>
<p><code>-a 32</code> sets the number of KDF rounds. The standard is usually good enough,
adding extra rounds can make it harder to brute-force.</p>
</li>
<li>
<p><code>-f</code> is for filename</p>
</li>
</ul>
<hr />
<h2 id="gnupg-and-gpg-agent"><a class="header" href="#gnupg-and-gpg-agent">GnuPG and gpg-agent</a></h2>
<p><code>gpg --full-generate-key</code> can be used to generate a basic keypair.</p>
<p><code>gpg --expert --full-generate-key</code> can be used for keys that require more
capabilities.</p>
<blockquote>
<p>❗ NOTE: We will first generate our GPG primary key that is required to
atleast have sign capabilities, we will then derive subkeys from said primary
key and use them for signing and encrypting. It is recommended to generate a
revoke certificate right after creating your primary key.</p>
</blockquote>
<p>To generate your gpg primary key you can do the following:</p>
<pre><code class="language-bash">gpg --full-generate-key
</code></pre>
<ul>
<li>
<p>Choose <code>(10) (sign only)</code></p>
</li>
<li>
<p>Give it a name and description</p>
</li>
<li>
<p>Give it an expiration date, 1y is common</p>
</li>
<li>
<p>Use a strong passphrase or password</p>
</li>
<li>
<p>Give it a comment, I typically add the date</p>
</li>
</ul>
<p>If you see a warning about incorrect permissions, you can run the following:</p>
<pre><code class="language-bash">chmod 700 ~/.gnupg
chmod 600 ~/.gnupg/*
</code></pre>
<p>Verify:</p>
<pre><code class="language-bash">ls -ld ~/.gnupg
# Should show: drwx------

ls -l ~/.gnupg
# Files should show: -rw-------
</code></pre>
<hr />
<h3 id="generate-a-revocation-certificate"><a class="header" href="#generate-a-revocation-certificate">Generate a Revocation Certificate</a></h3>
<p><code>mykey</code> must be a key specifier, either the keyID of the primary keypair or any
part of the user ID that identifies the keypair:</p>
<p>Replace <code>mykeyID</code> with the keyID of your primary key and store the cert in a
safe place:</p>
<pre><code class="language-bash">gpg --output revoke.asc --gen-revoke mykeyID
Create a revocation certificate for this key? (y/N)
Please select the reason for the revocation:
  0 = No reason specified
  1 = Key has been compromised
  2 = Key is superseded
  3 = Key is no longer used
  Q = Cancel
(Probably you want to select 1 here)
Your decision?
</code></pre>
<p>The certificate will be output to a file <code>revoke.asc</code>. If the <code>--output</code> is
ommitted, the result will be placed on stdout.</p>
<p>Since it's a short certificate, you can print a hardcopy and store it somewhere
safe. The cert shouldn't be somewhere that others can access it since anyone
could publish the revoke cert and render the corresponding public key useless.</p>
<p>To apply the revoke cert, import it:</p>
<pre><code class="language-bash">gpg --import revoke.asc
# And optionally push the revoked key to public keyservers to notify others:
gpg --keyserver keyserver.ubuntu.com --send-keys YOUR_KEYID
</code></pre>
<hr />
<h3 id="generate-gpg-subkeys"><a class="header" href="#generate-gpg-subkeys">Generate Gpg Subkeys</a></h3>
<pre><code class="language-bash"># Take note of your public key
gpg --list-keys --with-fingerprint
/home/jr/.gnupg/pubring.kbx
---------------------------
pub   ed25519/0x095782A1B124AF15 2025-08-23 [SCA] [expires: 2026-08-23]
Key fingerprint = 5908 9C5B FEC8 0D75 FCB0  E206 0958 82C1 A124 CF15
uid                   [ultimate] Jr (08-23-25) &lt;sayls8@proton.me&gt;
</code></pre>
<ul>
<li>Copy the KeyID, in this example it would be <code>0x095722B2A123CF15</code>. We will use
it for the command below.</li>
</ul>
<p>Now we will generate 2 subkeys, 1 for encryption and 1 for authentication.</p>
<pre><code class="language-bash">gpg --expert --edit-key 0x095722B2A123CF15
</code></pre>
<p>Choose 11 (set your own capabilities) and add A (Authenticate) and type Q.
Create another key while still in the menu with only encrypt capabilities.</p>
<blockquote>
<p>❗ <code>gpg --edit-key</code> has many more capabilities, after launching type <code>help</code>.</p>
</blockquote>
<p><strong>Add Keygrip of Authenticate Subkey to <code>sshcontrol</code> for gpg-agent</strong></p>
<pre><code class="language-bash">gpg --list-secret-keys --with-keygrip --keyid-format LONG
</code></pre>
<p>Copy the keygrip of the subkey with Authenticate capabilities</p>
<pre><code class="language-bash">echo "6BD11826F3845BC222127FE3D22C92C91BB3FB32" &gt; ~/.gnupg/sshcontrol
</code></pre>
<pre><code class="language-bash">ssh-add -L
# you should see something like:
ssh-ed25519 AABCC3NzaC1lZDI1NTE5ABBAIHyujgyCjjBTqIuFM3EMUSo6RGklmOXQW3uWRhWdJ1Mm (none)
</code></pre>
<ul>
<li>By itself, a keygrip cannot be used to reconstruct your private key. It's
derived from the public key material, not from the secret key itself so it's
safe to version control. Don't put your keygrip in a public repo if you don't
want people to know you use that key for signing/authentication. It's not a
security risk, but it leaks a tiny bit of metadata.</li>
</ul>
<p>The following article mentions the keygrip being computed from public elements
of the key:</p>
<ul>
<li><a href="https://gnupg-users.gnupg.narkive.com/q5JtahdV/gpg-agent-what-is-a-keygrip">gnupg-users what-is-a-keygrip</a></li>
</ul>
<p>Create a <code>~/.gnupg/gpg.conf</code>:</p>
<p>Copy the KeyID of the key with Authenticate capabilities and use it as your
default-key in <code>gpg.conf</code>:</p>
<ul>
<li><a href="https://riseup.net/ru/security/message-security/openpgp/gpg-best-practices">RiseUp GPG Best Practices</a></li>
</ul>
<pre><code class="language-bash">#
# This is an implementation of the Riseup OpenPGP Best Practices
# https://help.riseup.net/en/security/message-security/openpgp/best-practices
#


#-----------------------------
# default key
#-----------------------------

# The default key to sign with. If this option is not used, the default key is
# the first key found in the secret keyring

#default-key 0xD8692123C4065DEA5E0F3AB5249B39D24F25E3B6


#-----------------------------
# behavior
#-----------------------------

# Disable inclusion of the version string in ASCII armored output
no-emit-version

# Disable comment string in clear text signatures and ASCII armored messages
no-comments

# Display long key IDs
keyid-format 0xlong

# List all keys (or the specified ones) along with their fingerprints
with-fingerprint

# Display the calculated validity of user IDs during key listings
list-options show-uid-validity
verify-options show-uid-validity

# Try to use the GnuPG-Agent. With this option, GnuPG first tries to connect to
# the agent before it asks for a passphrase.
use-agent


#-----------------------------
# keyserver
#-----------------------------

# This is the server that --recv-keys, --send-keys, and --search-keys will
# communicate with to receive keys from, send keys to, and search for keys on
keyserver hkps://keys.openpgp.org/

# Set the proxy to use for HTTP and HKP keyservers - default to the standard
# local Tor socks proxy
# It is encouraged to use Tor for improved anonymity. Preferrably use either a
# dedicated SOCKSPort for GnuPG and/or enable IsolateDestPort and
# IsolateDestAddr
#keyserver-options http-proxy=socks5-hostname://127.0.0.1:9050

# Don't leak DNS, see https://trac.torproject.org/projects/tor/ticket/2846
keyserver-options no-try-dns-srv

# When using --refresh-keys, if the key in question has a preferred keyserver
# URL, then disable use of that preferred keyserver to refresh the key from
keyserver-options no-honor-keyserver-url

# When searching for a key with --search-keys, include keys that are marked on
# the keyserver as revoked
keyserver-options include-revoked


#-----------------------------
# algorithm and ciphers
#-----------------------------

# list of personal digest preferences. When multiple digests are supported by
# all recipients, choose the strongest one
personal-cipher-preferences AES256 AES192 AES CAST5

# list of personal digest preferences. When multiple ciphers are supported by
# all recipients, choose the strongest one
personal-digest-preferences SHA512 SHA384 SHA256 SHA224

# message digest algorithm used when signing a key
cert-digest-algo SHA512

# This preference list is used for new keys and becomes the default for
# "setpref" in the edit menu
default-preference-list SHA512 SHA384 SHA256 SHA224 AES256 AES192 AES CAST5 ZLIB BZIP2 ZIP Uncompressed
</code></pre>
<p>Add the following to your shell config, either <code>.bashrc</code> or <code>.zshrc</code>:</p>
<pre><code class="language-zsh">GPG_TTY=$(tty)
export GPG_TTY
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpgconf --launch gpg-agent
</code></pre>
<p>Rebuild and then restart <code>gpg-agent</code> if necessary:</p>
<pre><code class="language-bash">gpgconf --kill gpg-agent
gpgconf --launch gpg-agent
</code></pre>
<p>Test, these should match:</p>
<pre><code class="language-bash">echo "$SSH_AUTH_SOCK"
# output
/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76534j/S.gpg-agent.ssh

gpgconf --list-dirs agent-ssh-socket
# output
/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76834j/S.gpg-agent.ssh
</code></pre>
<pre><code class="language-bash">ssh-add -L
# Copy the entire following line:
ssh-ed25519 AABBC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I (none)
</code></pre>
<ul>
<li>It shows <code>(none)</code> because the comment field is blank on subkeys.</li>
</ul>
<h3 id="backing-up-your-keys"><a class="header" href="#backing-up-your-keys">Backing up Your Keys</a></h3>
<pre><code class="language-bash">gpg --export-secret-keys --armor --output my-private-key-backup.gpg
</code></pre>
<p>Your private keys will be encrypted with a passphrase into a .gpg file. Store
this backup in a secure location line an encrypted USB drive. This can prevent
you from losing access to your keys in the case of disk failure or accidents.</p>
<p>You can export your public keys and publish them publicly if you choose:</p>
<pre><code class="language-bash">gpg --export --armor --output my-public-keys.gpg
</code></pre>
<p>Now if your keys ever get lost or corrupted, you can import these backups.</p>
<p>--</p>
<h3 id="remove-and-store-your-primary-key-offline"><a class="header" href="#remove-and-store-your-primary-key-offline">Remove and Store your Primary Key offline</a></h3>
<blockquote>
<p>❗ NOTE: After you remove your primary key, you will no longer be able to
derive subkeys from it or sign keys unless you re-import it.</p>
</blockquote>
<pre><code class="language-bash"># extract the primary key
gpg -a --export-secret-key sayls8@proton.me &gt; secret_key
# extract the subkeys, which we will reimport later
gpg -a --export-secret-subkeys sayls8@proton.me &gt; secret_subkeys.gpg
# delete the secret keys from the keyring, so only subkeys are left
gpg --delete-secret-keys sayls8@proton.me
Delete this key from the keyring? (y/N) y
This is a secret key! - really delete? (y/N) y
# reimport the subkeys
gpg --import secret_subkeys.gpg
# verify everything is in order
gpg --list-secret-keys
# remove the subkeys from disk
rm secret_subkeys.gpg
</code></pre>
<p>I recommend also keeping a <code>.gpg</code> version to make it easy to re-import your
primary key: <code>gpg --export-secret-keys --armor --output private-key-bak.gpg</code></p>
<p>Then store <code>secret_key</code> on an encrypted USB drive or somewhere offline. If you
want to protect it for now, you can just use the encryption subkey that we
created to encrypt <code>secret_key</code> with a passphrase:</p>
<pre><code class="language-bash">gpg --list-keys --keyid-format LONG
</code></pre>
<p>Copy the KeyID of the subkey with encrypt capabilities for the following
command:</p>
<pre><code class="language-bash"># Encrypting your secret key for yourself
gpg --encrypt --recipient Ox37ACA569C5C44787 secret_key
</code></pre>
<p>You can check that the secret key material is missing with
<code>gpg --list-secret-keys</code>, you should see <code>sec#</code> instead of <code>sec</code>.</p>
<pre><code class="language-bash">gpg --list-secret-keys
# Output:
sec#  ed25519/0x
# ...snip...
</code></pre>
<p>The above set of commands are from the
<a href="https://riseup.net/ru/security/message-security/openpgp/gpg-best-practices#keep-your-primary-key-entirely-offline">RiseUp Keep your primary key offline</a></p>
<hr />
<h2 id="hardening-openssh"><a class="header" href="#hardening-openssh">Hardening OpenSSH</a></h2>
<p>Install and configure fail2ban:</p>
<pre><code class="language-bash">sudo pacman -S fail2ban
</code></pre>
<p>Create a <code>/etc/fail2ban/jail.local</code> file:</p>
<pre><code class="language-bash">[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 5
bantime = 3600  # 1 hour in seconds
findtime = 600
ignoreip = 127.0.0.1/8 ::1
banaction = iptables-multiport
</code></pre>
<p>Start and enable the service:</p>
<pre><code class="language-bash">sudo systemctl enable fail2ban
sudo systemctl start fail2ban
</code></pre>
<p>Harden OpenSSH settings in <code>/etc/ssh/sshd_config</code>:</p>
<pre><code class="language-bash">PasswordAuthentication no
PermitEmptyPasswords no
PubkeyAuthentication yes
AuthorizedKeysFile     %h/.ssh/authorized_keys
UsePAM yes
PermitTunnel no
UseDNS no
KbdInteractiveAuthentication no
X11Forwarding no  # or yes if you have X server enabled
MaxAuthTries 3
MaxSessions 2
ClientAliveInterval 300
ClientAliveCountMax 0
AllowUsers your-user
TCPKeepAlive no
AllowTcpForwarding no
AllowAgentForwarding no
LogLevel VERBOSE
PermitRootLogin no
KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com
</code></pre>
<p>Enable and start sshd:</p>
<pre><code class="language-bash">sudo systemctl enable sshd
sudo systemctl start sshd
</code></pre>
<p>Ensure all of the permissions are correct:</p>
<pre><code class="language-bash">chmod 755 $HOME
chmod 700 $HOME/.ssh
chmod 600 $HOME/.ssh/authorized_keys
</code></pre>
<p>Add the output of <code>ssh-add -L</code> to <code>~/.ssh/authorized_keys</code></p>
<pre><code class="language-bash">echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I (none)" &gt; ~/.ssh/authorized_keys
</code></pre>
<p>Finally, test an ssh connection:</p>
<pre><code class="language-bash">ssh user@hostname
# Example
ssh jr@archlinux
# Specify the port
ssh -p 22 user@hostname
</code></pre>
<hr />
<h4 id="tip-change-the-default-port"><a class="header" href="#tip-change-the-default-port">Tip Change the Default Port</a></h4>
<blockquote>
<p>⚠️ Critical Warning: Do not close your existing SSH session until you
successfully connect using the new port. If you make a mistake and get locked
out, you'll need console access to your server to fix it</p>
</blockquote>
<p>Edit <code>/etc/ssh/sshd_config</code> to add the line:</p>
<pre><code class="language-config">Port 2222
</code></pre>
<p>Update the Firewall Rules in <code>/etc/nftables.conf</code>:</p>
<pre><code class="language-conf"># ...snip...
table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback
        iif "lo" accept

        # Accept established and related connections
        ct state established,related accept

        # Allow ICMPv6
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept

        # Allow SSH (port 2222)
        tcp dport 2222 ct state new accept

        # Allow HTTP and HTTPS (ports 80 and 443)
        tcp dport {80,443} ct state new accept
    }
# ...snip...
</code></pre>
<p>Reload the Firewall:</p>
<pre><code class="language-bash">sudo nft -f /etc/nftables.conf
</code></pre>
<p>Restart sshd:</p>
<pre><code class="language-bash">sudo systemctl restart sshd
</code></pre>
<p>Finally, text a connection:</p>
<pre><code class="language-bash">ssh -p 2222 user@hostname
</code></pre>
<hr />
<h2 id="usb-port-protection"><a class="header" href="#usb-port-protection">USB Port Protection</a></h2>
<p>It's important to protect your USB ports to prevent BadUSB attacks, data
exfiltration, unauthorized device access, malware injection, etc.</p>
<p>To get a list of your connected USB devices you can use <code>lsusb</code> from the
<code>usbutils</code> package.</p>
<pre><code class="language-bash">lsusb
</code></pre>
<p>Generate a policy based on your currently attached USB devices with:</p>
<pre><code class="language-bash">sudo usbguard generate-policy | sudo tee /etc/usbguard/rules.conf
</code></pre>
<pre><code class="language-bash">sudo chmod 600 /etc/usbguard/rules.d/99-policy.conf
</code></pre>
<h3 id="usbguard-daemon"><a class="header" href="#usbguard-daemon">USBGuard Daemon</a></h3>
<p>Edit <code>/etc/usbguard/usbguard-daemon.conf</code> to set the policy to allow devices
that are already connected for root and your user:</p>
<pre><code class="language-conf"># Default policy for devices that were already connected when the daemon started.
# Supported values: apply-policy, allow, block, reject, keep.
PresentDevicePolicy=allow

# A list of users and groups that are allowed to interact with the daemon
# via the IPC interface.
IPCAllowedUsers=root your-user
</code></pre>
<p>From the above file we can see that it expects its configuration file to be
located at <code>/etc/usbguard/rules.d/</code>:</p>
<pre><code class="language-bash">sudo mkdir -p /etc/usbguard/rules.d
</code></pre>
<p>Create a file <code>/etc/usbguard/rules.d/99-policy.conf</code>:</p>
<pre><code class="language-conf"># allow `only` devices with mass storage interfaces (USB Mass Storage)
allow with-interface equals { 08:*:* }

# allow mice and keyboards
# allow with-interface equals { 03:*:* }

# Reject devices with suspicious combination of interfaces
reject with-interface all-of { 08:*:* 03:00:* }
reject with-interface all-of { 08:*:* 03:01:* }
reject with-interface all-of { 08:*:* e0:*:* }
reject with-interface all-of { 08:*:* 02:*:* }
</code></pre>
<p>The above policy can be found in
<a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/security_guide/sec-using-usbguard">RedHat UsbGuard</a></p>
<p>The only allow rule is for devices with only mass storage interfaces (08:<em>:</em>)
i.e., USB Mass storage devices, devices like keyboards and mice (which use
interface class <code>03:*:*</code>) implicitly not allowed.(commented out)</p>
<p>The reject rules reject devices with a suspicious combination of interfaces. A
USB drive that implements a keyboard or a network interface is very suspicious,
these reject rules prevent that.</p>
<p>The <code>presentDevicePolicy = "allow"</code> allows any device that is present at daemon
start up even if they're not explicitly allowed. However, newly plugged in
devices must match an allow rule or get denied implicitly.</p>
<p>Enable/Start <code>usbguard.service</code>:</p>
<pre><code class="language-bash">sudo systemctl enable usbguard
sudo systemctl start usbguard --now
</code></pre>
<p>Check status:</p>
<pre><code class="language-bash">sudo systemctl status usbguard
</code></pre>
<ul>
<li>If you plug something new in and it doesn't work, this is why. Remember this!</li>
</ul>
<hr />
<h3 id="firejail"><a class="header" href="#firejail">Firejail</a></h3>
<ul>
<li><a href="https://wiki.archlinux.org/title/Firejail">Arch Wiki Firejail</a></li>
</ul>
<pre><code class="language-bash">sudo pacman -S firejail
</code></pre>
<p>Usage:</p>
<pre><code class="language-bash">firejail librewolf
</code></pre>
<p>Using by default:</p>
<pre><code class="language-bash">sudo firecfg
</code></pre>
<p>This creates symbolic links in <code>/usr/local/bin/</code> pointing to <code>/usr/bin/firejail</code>
for programs for which Firejail has default or self-created profiles.</p>
<p>You can inspect <code>/etc/firejail/</code> to see all the pre-baked profiles available.</p>
<p>With firejail running, I noticed that none of my browsers would allow me to
download anything. A fix for this is to run:</p>
<pre><code class="language-bash">sudo firejail --noprofile firefox
</code></pre>
<p>Download your file, close firefox and run again in the firejail sandbox.</p>
<hr />
<h2 id="apparmor"><a class="header" href="#apparmor">AppArmor</a></h2>
<p><a href="https://apparmor.net/">AppArmor</a> is a
<a href="https://wiki.archlinux.org/title/Mandatory_Access_Control">Mandatory Access Control</a>
(MAC) system, implemented upon the
<a href="https://en.wikipedia.org/wiki/Linux_Security_Modules">Linux Security Modules</a>(LSM)
-- Arch Wiki</p>
<p>MAC systems generally block all access by default, only permitting actions that
are explicitly defined as allowed in their security policy or access profiles.</p>
<p>This is why, if you read about creating your own policy that they recommend
setting AppArmor to complain mode while you use said app using all functionality
and APIs you can think of before setting to enforce. Within a policy everything
is default-deny so any action not covered in the above steps will be blocked by
default.</p>
<blockquote>
<p>❗️ The AppArmor policy con only be considered default deny if it is deployed
as a complete system policy which we don't do here. The apps and parts of the
system that don't have pre-defined policies aren't covered by AppArmor so are
therefore default allow. You can get there in time but it's beyond the scope
of this section.</p>
</blockquote>
<p>Install:</p>
<pre><code class="language-bash">sudo pacman -S apparmor
</code></pre>
<p>Add the following to <code>/etc/default/grub</code> in <code>GRUB_CMDLINE_LINUX_DEFAULT</code>:</p>
<pre><code class="language-grub">GRUB_CMDLINE_LINUX_DEFAULT="lsm=landlock,lockdown,yama,integrity,apparmor,bpf"
</code></pre>
<p>Rebuild grub:</p>
<pre><code class="language-bash">sudo grub-mkconfig -o /boot/grub/grub.cfg
</code></pre>
<p>Start/Enable AppArmor:</p>
<pre><code class="language-bash">sudo systemctl start apparmor
sudo systemctl enable apparmor
</code></pre>
<p>Ensure the LSM is loaded with:</p>
<pre><code class="language-bash">zgrep CONFIG_LSM=/proc/config.gz
# &amp;
cat /sys/kernel/security/lsm
</code></pre>
<p>Reboot, and run <code>sudo aa-enabled</code>, and <code>sudo aa-status</code>. You should see many
profiles in enforce mode.</p>
<p>Further reading:</p>
<ul>
<li>
<p><a href="https://apparmor.net/">AppArmor Quick Intro</a></p>
</li>
<li>
<p><a href="https://gitlab.com/apparmor/apparmor/-/wikis/home">AppArmor Wiki</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/AppArmor">Arch Wiki AppArmor</a></p>
</li>
</ul>
<pre><code class="language-bash">paru -S bazaar
</code></pre>
<p>speling eror</p>
<h2 id="creating-profiles-that-arent-pre-configured"><a class="header" href="#creating-profiles-that-arent-pre-configured">Creating profiles that aren't pre-configured</a></h2>
<h3 id="auditd"><a class="header" href="#auditd">Auditd</a></h3>
<p>Install with:</p>
<pre><code class="language-bash">sudo pacman -S audit
</code></pre>
<p>Enable:</p>
<pre><code class="language-bash">sudo systemctl enable auditd
sudo systemctl start auditd --now
</code></pre>
<p>To create new profiles, <code>auditd</code> should be running. AppArmor can use kernel
audit logs from the userspace auditd daemon, allowing you to build new profiles.</p>
<ul>
<li><a href="https://wiki.archlinux.org/title/Audit_framework">Audit Framework</a></li>
</ul>
<p>A basic set of rules could be to create a <code>/etc/audit/rules.d/audit.rules</code> with
the following contents:</p>
<pre><code class="language-audit.rules"># Clear existing rules
-D

# Set buffer size
-b 8192

# Monitor /etc/passwd for modifications
-w /etc/passwd -p wa -k passwd_changes

# Monitor sudo command execution
-w /usr/bin/sudo -p x -k sudo_usage

# Enable auditing
-e 1
</code></pre>
<p>Validate and load the rules, this will populate <code>/etc/audit/audit.rules</code> with
the rules we just set:</p>
<pre><code class="language-bash">sudo augenrules --load
</code></pre>
<p>Ensure <code>auditd</code> is running:</p>
<pre><code class="language-bash">sudo systemctl status auditd
</code></pre>
<p>Since we set a watch rule for sudo let's run an update and check the auditd
logs:</p>
<pre><code class="language-bash">sudo pacman -Syu
sudo ausearch -k sudo_usage
</code></pre>
<p>Verify the rules are loaded:</p>
<pre><code class="language-bash">sudo auditctl -l
</code></pre>
<p>Be careful here, if you enable <code>auditd</code> and don't iron out the kinks I've found
that it freezes after you enter your cryptroot passphrase. If this happens to
you, follow the chroot steps but skip the <code>arch-chroot /mnt</code> step and instead
run:</p>
<pre><code class="language-bash">systemctl --root=/mnt disable auditd
</code></pre>
<p>Unmount the partitions, close cryptroot, and Reboot.</p>
<hr />
<h3 id="doas-over-sudo"><a class="header" href="#doas-over-sudo">Doas over sudo</a></h3>
<p>For a more minimalist version of <code>sudo</code> with a smaller codebase and attack
surface, consider <code>doas</code>:</p>
<pre><code class="language-bash">sudo pacman -S opendoas
</code></pre>
<p>Create <code>/etc/doas.conf</code> with the following contents:</p>
<pre><code class="language-conf">permit setenv {PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin} :wheel
</code></pre>
<p>You can add a line below that one like <code>permit nopass your-username as root:</code>
Enabling your user passwordless usage, it's much less secure but an option none
the less.</p>
<pre><code class="language-bash">doas pacman -R sudo base-devel
</code></pre>
<p>Secure the <code>doas.conf</code>:</p>
<pre><code class="language-conf">doas chown -c root:root /etc/doas.conf
doas chmod -c 0400 /etc/doas.conf
</code></pre>
<p>Create a symlink replacing sudo with doas:</p>
<pre><code class="language-bash">ln -s $(which doas) /usr/bin/sudo
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../arch/hardening_firefox.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../arch/hardening_firefox.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
