<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encrypted Arch Install - privacy-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">privacy-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="encrypted-arch-install-w-encrypted-swap"><a class="header" href="#encrypted-arch-install-w-encrypted-swap">Encrypted Arch Install w/ Encrypted Swap</a></h1>
<details>
<summary> ✔️ Click to Expand Table of Contents</summary>
<ul>
<li><a href="#automating-encrypted-swap-unlock">Automating Encrypted Swap Unlock</a></li>
<li><a href="#install-the-base-system-on-mnt-with-pacstrap">Install the Base System on <code>/mnt</code> with <code>pacstrap</code></a>
<ul>
<li><a href="#arch-chroot">arch-chroot</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</li>
</ul>
</details>
<p>The ultimate installation resource is always goint to be the:</p>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/title/Installation_guide">Arch Wiki Installation Guide</a></p>
</li>
<li>
<p><a href="https://archlinux.org/download/#checksums">Verify PGP Signatures</a>, the ISO
directory is just the same directory where your Arch Linux ISO file is stored.</p>
</li>
</ul>
<blockquote>
<p>Always review the Wiki and never just plug random things suggested by me or
anyone else without first doing your own research. If you have a ton of RAM
and don't want hibernation capabilities, you can safely skip the swap section.
There is no security benefit to using an encrypted swap over zram that I know
of since zram is stored in RAM it's wiped on power loss.</p>
</blockquote>
<details>
<summary> ✔️ Verifying Arch Linux ISO on Other Distributions </summary>
<blockquote>
<p>❗ NOTE: If you only want to verify the ISO once, you can temporarily import
the public key, verify the signature, and then you don’t need to keep the key
permanently in your keyring or sign it locally. This example is from the last
release, but the process is the same.</p>
</blockquote>
<p>With <code>sequoia</code>, you can get the Arch release signing key with:</p>
<pre><code class="language-bash">sq network wkd search pierre@archlinux.org --output release-key.pgp
</code></pre>
<p>Export the chosen key to a <code>.pgp</code> file:</p>
<pre><code class="language-bash">sq cert export --keyring=release-key.pgp --cert=3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C &gt; pierre-archlinux.pgp
</code></pre>
<p>Import into your keychain:</p>
<pre><code class="language-bash"> gpg --import pierre-archlinux.pgp
gpg: key 0x76A5EF9054449A5C: 9 signatures not checked due to missing keys
gpg: key 0x76A5EF9054449A5C: public key "Pierre Schmitz &lt;pierre@archlinux.org&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   3  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 3u
gpg: next trustdb check due at 2026-08-23
</code></pre>
<ul>
<li>Now, you should see <code>&lt;pierre@archlinux.org&gt;</code> and his keys when you run
<code>gpg --list-keys</code></li>
</ul>
<p>Finally, verify the signature:</p>
<pre><code class="language-bash">sq verify --signer-file release-key.pgp --signature-file archlinux-2025.08.01-x86_64.iso.sig archlinux-2025.08.01-x86_64.iso
Authenticated signature made by 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C (Pierre Schmitz &lt;pierre@archlinux.org&gt;)

1 authenticated signature.
</code></pre>
<blockquote>
<p>❗ To ensure the key is authentic and not spoofed, verify that the key
fingerprint matches the official Arch Linux signing key fingerprint, which can
is linked below and on the Arch website.</p>
</blockquote>
<p>This shows that the signature was made by the key with the ID
<code>3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C (Pierre Schmitz)</code></p>
<p>You can check the keys fingerprint with:</p>
<pre><code class="language-bash">gpg --fingerprint 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C
</code></pre>
<ul>
<li>Verify it against the
<a href="https://archlinux.org/master-keys/">Arch Linux master-keys</a></li>
</ul>
<p>✔️ Verifying Arch Linux ISO on Other Distributions</p>
<pre><code>❗ NOTE: If you only want to verify the ISO once, you can temporarily import the public key, verify the signature, and then you don’t need to keep the key permanently in your keyring or sign it locally. This example is from the last release, but the process is the same.
</code></pre>
<p>For example, if you have a folder named archISO where you keep the ISO file
archlinux-2025-09.01-x86_64.iso, you should also download the PGP signature file
archlinux-2025.09.01-x86_64.iso.sig to the same folder.</p>
<p>With sequoia(a separate app), you can get the Arch release signing key with:</p>
<p>sq network wkd search pierre@archlinux.org --output release-key.pgp</p>
<p>Export the chosen key to a .pgp file:</p>
<p>sq cert export --keyring=release-key.pgp
--cert=3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C &gt; pierre-archlinux.pgp</p>
<p>Import into your keychain:</p>
<pre><code class="language-bash"> gpg --import pierre-archlinux.pgp
gpg: key 0x76A5EF9054449A5C: 9 signatures not checked due to missing keys
gpg: key 0x76A5EF9054449A5C: public key "Pierre Schmitz &lt;pierre@archlinux.org&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   3  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 3u
gpg: next trustdb check due at 2026-08-23
</code></pre>
<ul>
<li>Now, you should see <a href="mailto:pierre@archlinux.org">pierre@archlinux.org</a> and his keys when you run gpg
--list-keys</li>
</ul>
<p>Finally, verify the signature:</p>
<pre><code class="language-bash">sq verify --signer-file release-key.pgp --signature-file archlinux-2025.08.01-x86_64.iso.sig archlinux-2025.08.01-x86_64.iso
Authenticated signature made by 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C (Pierre Schmitz &lt;pierre@archlinux.org&gt;)
1 authenticated signature.
</code></pre>
<blockquote>
<p>❗ To ensure the key is authentic and not spoofed, verify that the key
fingerprint matches the official Arch Linux signing key fingerprint, which can
is linked below and on the Arch website.</p>
</blockquote>
<p>This shows that the signature was made by the key with the ID
<code>3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C</code> (Pierre Schmitz).</p>
<p>You can check the keys fingerprint with:</p>
<pre><code class="language-bash">gpg --fingerprint 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C
</code></pre>
<p>Verify it against the Arch Linux master-keys</p>
<p>With the <code>sq verify</code> command GPG authenticated that the signature is valid and
that the key used to sign is trusted in our keyring.</p>
<p><code>1 authenticated signature</code> confirms the files integrity and authenticity.</p>
<p>We have successfully verified that the file was signed by Pierr's official Arch
Linux key and has not been tampered with.</p>
<p>The following is only if you currently already have keys on your gpg keyring.</p>
<details>
<summary> ☑️ Click to expand Key Signing and Publishing Example </summary>
<p>List your keys to get the arch keyID:</p>
<pre><code class="language-bash">gpg --list-keys
# ... snip ...
pub   ed25519/0x76A5EF9054449A5C 2022-10-31 [SC] [expires: 2037-10-27]
      Key fingerprint = 3E80 CA1A 8B89 F69C BA57  D98A 76A5 EF90 5444 9A5C
uid                   [  full  ] Pierre Schmitz &lt;pierre@archlinux.org&gt;
uid                   [  full  ] Pierre Schmitz &lt;pierre@archlinux.de&gt;
sub   ed25519/0xD6D13C45BFCFBAFD 2022-10-31 [A] [expires: 2037-10-27]
sub   cv25519/0x7F56ADE50CA3D899 2022-10-31 [E] [expires: 2037-10-27]
</code></pre>
<p>Sign the key:</p>
<pre><code class="language-bash">gpg --sign-key 0x76A5EF9054449A5C
</code></pre>
<p>Now you can export and publish the new public key and send it to a keyserver:</p>
<pre><code class="language-bash">gpg --export --armor 0x76A5EF9054449A5C &gt; archlinux-signed.asc
gpg --send-keys 0x76A5EF9054449A5C
</code></pre>
<p>The more people that verify, sign, and re-export and publish their keys the
better for the web of trust that gpg uses making the network more secure for
everyone.</p>
</details>
</details>
<ol>
<li><strong>Connect to Wi-Fi</strong>:</li>
</ol>
<pre><code class="language-bash">iwctl
[iwd]# device list
[iwd]# station wlan0 scan
[iwd]# station wlan0 connect NETGEAR80
# Enter your Password
# Check Connection
[iwd]# station wlan0 show
[iwd]# exit
</code></pre>
<pre><code class="language-bash">ping -c 3 archlinux.org
</code></pre>
<hr />
<ol start="2">
<li><strong>Update package databases and mirrorlist</strong>:</li>
</ol>
<pre><code class="language-bash">pacman -Sy
</code></pre>
<p>Save a backup of your current mirrorlist so we can safely update it:</p>
<pre><code class="language-bash">cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak
</code></pre>
<pre><code class="language-bash">pacman -S reflector
reflector --list-countries
# Example if you live in the US
reflector -c US --protocol https --age 6 --fastest 5 --sort rate --save /etc/pacman.d/mirrorlist
</code></pre>
<hr />
<p>3 <strong>Set system clock</strong>:</p>
<pre><code class="language-bash">timedatectl set-ntp true
timedatectl list-timezones
# Example
sudo timedatectl set-timezone America/New_York
</code></pre>
<hr />
<ol start="4">
<li><strong>Partition your Disk</strong>:</li>
</ol>
<p>Identify your target disk (e.g., <code>/dev/mmcblk0</code>):</p>
<pre><code class="language-bash">lsblk
</code></pre>
<blockquote>
<p>❗ If you already have an EFI partition you do not have to create another one
and doing so can cause issues. First check with fdisk -l, before creating a
new one.</p>
</blockquote>
<pre><code class="language-bash">fdisk -l | less
Device            Size           Type
/dev/mmcblk0p1     1G            EFI System
/dev/mmcblk0p2     57.2G         Linux root (x86-64)
</code></pre>
<p>Since I already have a 1G EFI and another root partition with the rest of the
space, I'll only need cfdisk to resize <code>mmcblk0p2</code> in order to make a swap
partition.</p>
<pre><code class="language-bash">mkdir -p /mnt/boot
mount /dev/mmcblk0p1 /mnt/boot
</code></pre>
<hr />
<ol start="5">
<li>If you have a disk with no partitions on it, you'll have to use a
partitioning tool to create them. I'll use cfdisk as an example:</li>
</ol>
<pre><code class="language-bash">cfdisk /dev/mmcblk0
</code></pre>
<p><code>Select label type -&gt; gpt</code></p>
<p><code>Free space -&gt; 1G</code> (1G boot partition)</p>
<p><code>type -&gt; EFI System</code></p>
<p>Stay in cfdisk and go to <code>type -&gt; Linux swap</code></p>
<p><code>Free space -&gt; RAM+2G</code> (RAM+2G Swap)</p>
<p>Stay in cfdisk <code>type -&gt; Linux filesystem</code></p>
<p><code>Free space -&gt; The Rest</code> (The Rest Root partition)</p>
<p><code>Write -&gt; Quit</code></p>
<hr />
<ol start="6">
<li><strong>Format the EFI partition as FAT32</strong>:</li>
</ol>
<pre><code class="language-bash">mkfs.fat -F32 /dev/mmcblk0p1
</code></pre>
<p>Leave the root partition unformatted for the next step.</p>
<hr />
<ol start="7">
<li><strong>Encrypt the Root partition and Open it</strong>:</li>
</ol>
<pre><code class="language-bash">cryptsetup luksFormat /dev/mmcblk0p2
cryptsetup open /dev/mmcblk0p2 cryptroot
</code></pre>
<p>Create a filesystem:</p>
<pre><code class="language-bash">mkfs.btrfs /dev/mapper/cryptroot
mount /dev/mapper/cryptroot /mnt
</code></pre>
<p>Later, we will enable compression by mounting with options like <code>compress=zstd</code>
in <code>fstab</code></p>
<hr />
<ol start="8">
<li><strong>Encrypted Swap</strong></li>
</ol>
<blockquote>
<p>❗ NOTE: If you have a ton of RAM a swap is probably unnecessary unless you
want hibernation, which requires it. Anything over 16G of RAM and it is
questionable if you need swap at all and should probably just use zram.</p>
</blockquote>
<p>Verify your swap partition created earlier, in this section we assume the swap
partition is <code>/dev/mmcblk0p3</code>:</p>
<pre><code class="language-bash">lsblk -f
</code></pre>
<p>Encrypt the swap partiton with LUKS:</p>
<pre><code class="language-bash">cryptsetup luksFormat /dev/mmcblk0p3
# Open the encrypted swap
cryptsetup open /dev/mmcblk0p3 cryptswap
</code></pre>
<p>Format the decrypted swap partition:</p>
<pre><code class="language-bash">mkswap /dev/mapper/cryptswap
</code></pre>
<p>Enable the swap:</p>
<pre><code class="language-bash">swapon /dev/mapper/cryptswap
</code></pre>
<p>Add the swap to <code>/mnt/etc/fstab</code> (this will be updated later in the <code>genfstab</code>
step, but you can manually ensure it):</p>
<pre><code class="language-bash">echo '/dev/mapper/cryptswap none swap defaults 0 0' &gt;&gt; /mnt/etc/fstab
</code></pre>
<p>Add the swap partition to the LUKS configuration for automatic unlocking on
boot:</p>
<pre><code class="language-bash">echo 'cryptswap /dev/mmcblk0p3 none luks' &gt;&gt; /mnt/etc/crypttab
</code></pre>
<blockquote>
<p>❗ Later, after arch-chroot, ensure the mkinitcpio.conf HOOKS include resume
(after encrypt) if you plan on using hibernation. This will be covered in the
<code>initramfs</code> step.</p>
</blockquote>
<hr />
<h3 id="automating-encrypted-swap-unlock"><a class="header" href="#automating-encrypted-swap-unlock">Automating Encrypted Swap Unlock</a></h3>
<p>To avoid entering a separate password for the swap on every boot, you can create
a keyfile that will automatically unlock the swap once the root partition is
decrypted. This is a recommended practice.</p>
<ol>
<li>Create a keyfile: Generate a random keyfile and save it to a secure location,
like /etc/.</li>
</ol>
<pre><code class="language-bash">dd if=/dev/urandom of=/etc/swap.key bs=4096 count=1
chmod 600 /etc/swap.key
</code></pre>
<p>Add the keyfile to the LUKS header: Add the keyfile as a new key to the
encrypted swap partition.</p>
<pre><code class="language-bash">cryptsetup luksAddKey /dev/mmcblk0p3 /etc/swap.key
</code></pre>
<p>Update <code>crypttab</code>: Modify the <code>/etc/crypttab</code> file to use the keyfile for
unlocking the swap partition instead of a password.</p>
<pre><code class="language-bash"># Open /etc/crypttab in a text editor like nano or vim
# and change the line to:
cryptswap UUID=&lt;your_swap_UUID&gt; /etc/swap.key luks
</code></pre>
<p>Update <code>mkinitcpio</code>:</p>
<pre><code class="language-bash">sudo mkinitcpio -P
</code></pre>
<p>Update <code>grub</code>:</p>
<pre><code class="language-bash">grub-mkconfig -o /boot/grub/grub.cfg
</code></pre>
<p>Now, when you boot and enter the password for your root partition, the system
will gain access to the keyfile, which will automatically unlock the encrypted
swap without requiring a second password.</p>
<h2 id="install-the-base-system-on-mnt-with-pacstrap"><a class="header" href="#install-the-base-system-on-mnt-with-pacstrap">Install the Base System on <code>/mnt</code> with <code>pacstrap</code></a></h2>
<p>If you prefer Nvim or a hardened kernel, change it here.</p>
<pre><code class="language-bash">pacstrap -K /mnt base linux-zen linux-zen-headers linux-firmware networkmanager helix grub lightdm lightdm-gtk-greeter btrfs-progs cryptsetup sudo base-devel
</code></pre>
<pre><code class="language-bash"># Check if EFI is mounted
mount | grep /mnt/boot
# List all mounts under /mnt
findmnt /mnt
</code></pre>
<p>The EFI and root partitions need to be mounted before you generate the
filesystem table in the next step.</p>
<hr />
<ol start="9">
<li><strong>Generate the Filesystem Table</strong>:</li>
</ol>
<pre><code class="language-bash">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
#
cat /mnt/etc/fstab
# Add compression
vim /mnt/etc/fstab
</code></pre>
<p><strong>Important</strong>: The <code>fstab</code> should list all 3 partitions, if it doesn't you'll
need to regenerate your fstab again with <code>genfstab</code>.</p>
<hr />
<ol start="10">
<li>Add compression, <strong>Only for the Root Partition</strong>:</li>
</ol>
<pre><code class="language-bash"># fstab
/dev/mapper/cryptroot    /    btrfs    rw,relatime,compress=zstd,ssd, #...snip
#...snip...
</code></pre>
<p>Remount root with compression:</p>
<pre><code class="language-bash">mount -o remount,compress=zstd /mnt
</code></pre>
<hr />
<ol start="11">
<li><strong>Change Root (<code>chroot</code>) into the New Installation</strong></li>
</ol>
<pre><code class="language-bash">arch-chroot /mnt
</code></pre>
<p>Create a user:</p>
<pre><code class="language-bash">useradd -m -G wheel -s /bin/bash yourusername
passwd yourusername
</code></pre>
<p>Enable sudo for wheel group:</p>
<pre><code>EDITOR=vim visudo
</code></pre>
<p>If that doesn't work, use <code>vim /etc/sudoers</code> and edit the file accordingly.</p>
<p>Uncomment the line:</p>
<pre><code class="language-bash">%wheel ALL=(ALL:All) ALL
</code></pre>
<hr />
<ol start="12">
<li>Edit <code>/etc/mkinitcpio.conf</code> in the new system to add an <code>encrypt</code> hook
before the <code>filesystems</code> attribute.</li>
</ol>
<ul>
<li>
<p>Locate the <code>HOOKS</code> line</p>
</li>
<li>
<p>Insert <code>encrypt</code> <strong>before</strong> filesystems</p>
</li>
</ul>
<pre><code class="language-bash">vim /etc/mkinitcpio.conf
</code></pre>
<blockquote>
<p>❗ NOTE how I also added the <code>resume</code> after <code>encrypt</code>, that's required for the
encrypted swap setup.</p>
</blockquote>
<pre><code class="language-bash"># mkinitcpio.conf
# ... snip ...
HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolfont block encrypt resume filesystems fsck)
# ... snip ...
</code></pre>
<hr />
<ol start="14">
<li><strong>Install Grub and EFI boot manager</strong>, (while still in chroot environment):</li>
</ol>
<pre><code class="language-bash">pacman -S grub efibootmgr
</code></pre>
<p>Install GRUB for UEFI Systems:</p>
<pre><code class="language-bash">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
# Should output
Installation finished. No error reported.
</code></pre>
<p>Configure GRUB to unlock LUKS root partition</p>
<p>Edit <code>/etc/default/grub</code> and modify line starting with <code>GRUB_CMDLINE_LINUX</code> to
add:</p>
<pre><code class="language-bash"># ...snip...
GRUB_CMDLINE_LINUX="cryptdevice=/dev/mmcblk0p2:cryptroot root=/dev/mapper/cryptroot"
# ...snip...
</code></pre>
<p>Generate GRUB configuration:</p>
<pre><code class="language-bash">grub-mkconfig -o /boot/grub/grub.cfg
# Should output
Adding boot menu entry for UEFI Firmware Settings ...
done
</code></pre>
<hr />
<ol start="15">
<li><strong>Enable LightDM and NetworkManager</strong></li>
</ol>
<pre><code class="language-bash">systemctl enable lightdm
systemctl enable NetworkManager
</code></pre>
<blockquote>
<p>NOTE: While following these exact steps on a different machine, the above
commands refused to run. The solution was to exit the chroot environment and
run the following:</p>
<pre><code class="language-bash">systemctl --root=/mnt enable lightdm
systemctl --root=/mnt enable NetworkManager
</code></pre>
</blockquote>
<p>Configure LightDM greeter, edit <code>/et/lightdm/lightdm.conf</code> to add:</p>
<pre><code class="language-conf"># lightdm.conf
[Seat:*]
greeter-session=lightdm-gtk-greeter
</code></pre>
<p>Exit <code>arch-chroot</code> with <code>exit</code></p>
<p>Unmount your partitions and reboot:</p>
<pre><code class="language-bash">umount /mnt/boot
umount /mnt
cryptsetup close cryptroot
</code></pre>
<hr />
<p>16 <strong>Reboot</strong></p>
<hr />
<h3 id="arch-chroot"><a class="header" href="#arch-chroot">arch-chroot</a></h3>
<details>
<summary>  ✔️ Click to Expand `arch-chroot` Example </summary>
<p>Say you forgot something, like forgetting to add a user and password. You reboot
and go to TTY into your system and are hit with a AHHH I can't log in WTF!</p>
<p>It's as easy as repeating some of the steps above. Reboot into the Live
environment, remount your partitions and <code>arch-chroot</code> back in:</p>
<p>Open the encrypted root partition:</p>
<pre><code class="language-bash">cryptsetup open /dev/mmcblk0p2 cryptroot
</code></pre>
<p>Mount the decrypted root:</p>
<pre><code class="language-bash">mount /dev/mapper/cryptroot /mnt
</code></pre>
<p>Mount the EFI partition:</p>
<pre><code class="language-bash">mount /dev/mmcblk0p1 /mnt/boot
</code></pre>
<p>Chroot into your installed system:</p>
<pre><code class="language-bash">arch-chroot /mnt
</code></pre>
<pre><code class="language-bash">useradd -m -G wheel -s /bin/bash yourusername passwd yourusername
</code></pre>
<ul>
<li>The <code>-s /bin/bash</code> sets your default shell, you can use zsh if you have it
installed.</li>
</ul>
<p>Uncomment the line <code>%wheel ALL=(ALL:All) ALL</code> in <code>/etc/sudoers</code></p>
<p>Exit chroot:</p>
<pre><code class="language-bash">exit
</code></pre>
<p>Unmount and close LUKS:</p>
<pre><code class="language-bash">umount /mnt/boot umount /mnt cryptsetup close cryptroot reboot
</code></pre>
<h3 id="resources"><a class="header" href="#resources">Resources</a></h3>
<ul>
<li><a href="https://wiki.archlinux.org/title/Installation_guide">Arch Wiki Installation Guide</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/RethinkDNS_Guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../arch/enc_dns.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/RethinkDNS_Guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../arch/enc_dns.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
