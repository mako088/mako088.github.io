<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encrypted Arch Install - privacy-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">privacy-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="encrypted-arch-install-for-uefi-systems-with-uki-and-secure-boot"><a class="header" href="#encrypted-arch-install-for-uefi-systems-with-uki-and-secure-boot">Encrypted Arch Install for UEFI Systems with UKI and Secure Boot</a></h1>
<details>
<summary> ✔️ Click to Expand Table of Contents</summary>
<ul>
<li><a href="#install-the-base-system-on-mnt-with-pacstrap">Install the Base System on <code>/mnt</code> with <code>pacstrap</code></a>
<ul>
<li><a href="#creating-a-readonly-snapshot-of-your-root-subvolume">Creating a readonly snapshot of your root subvolume:</a></li>
<li><a href="#restoring-from-a-backup">Restoring from a Backup</a></li>
<li><a href="#automated-backup">Automated backup</a></li>
<li><a href="#arch-chroot">arch-chroot</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</li>
</ul>
</details>
<p>The ultimate installation resource is always goint to be the:</p>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/title/Installation_guide">Arch Wiki Installation Guide</a></p>
</li>
<li>
<p><a href="https://archlinux.org/download/#checksums">Verify PGP Signatures</a>, the ISO
directory is just the same directory where your Arch Linux ISO file is stored.</p>
</li>
</ul>
<blockquote>
<p>Always review the Wiki and never just plug random things suggested by me or
anyone else without first doing your own research.</p>
</blockquote>
<p>Edited: 09-25-25 Removed encrypted swap section. Big usability downside IMO.</p>
<details>
<summary> ✔️ Verifying Arch Linux ISO on Other Distributions </summary>
<blockquote>
<p>❗ NOTE: If you only want to verify the ISO once, you can temporarily import
the public key, verify the signature, and then you don’t need to keep the key
permanently in your keyring or sign it locally. This example is from the last
release, but the process is the same.</p>
</blockquote>
<p>With <code>sequoia-sq</code>, you can get the Arch release signing key with:</p>
<pre><code class="language-bash">sq network wkd search pierre@archlinux.org --output release-key.pgp
</code></pre>
<p>Export the chosen key to a <code>.pgp</code> file:</p>
<pre><code class="language-bash">sq cert export --keyring=release-key.pgp --cert=3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C &gt; pierre-archlinux.pgp
</code></pre>
<p>Import into your keychain:</p>
<pre><code class="language-bash">gpg --import pierre-archlinux.pgp
gpg: key 0x76A5EF9054449A5C: 9 signatures not checked due to missing keys
gpg: key 0x76A5EF9054449A5C: public key "Pierre Schmitz &lt;pierre@archlinux.org&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   3  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 3u
gpg: next trustdb check due at 2026-08-23
</code></pre>
<ul>
<li>Now, you should see <code>&lt;pierre@archlinux.org&gt;</code> and his keys when you run
<code>gpg --list-keys</code></li>
</ul>
<p>Finally, verify the signature:</p>
<pre><code class="language-bash">sq verify --signer-file release-key.pgp --signature-file archlinux-2025.08.01-x86_64.iso.sig archlinux-2025.08.01-x86_64.iso
Authenticated signature made by 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C (Pierre Schmitz &lt;pierre@archlinux.org&gt;)

1 authenticated signature.
</code></pre>
<blockquote>
<p>❗ To ensure the key is authentic and not spoofed, verify that the key
fingerprint matches the official Arch Linux signing key fingerprint, which can
is linked below and on the Arch website.</p>
</blockquote>
<p>This shows that the signature was made by the key with the ID
<code>3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C (Pierre Schmitz)</code></p>
<p>You can check the keys fingerprint with:</p>
<pre><code class="language-bash">gpg --fingerprint 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C
</code></pre>
<ul>
<li>Verify it against the
<a href="https://archlinux.org/master-keys/">Arch Linux master-keys</a></li>
</ul>
<p>Verify it against the Arch Linux master-keys</p>
<p>With the <code>sq verify</code> command GPG authenticated that the signature is valid and
that the key used to sign is trusted in our keyring.</p>
<p><code>1 authenticated signature</code> confirms the files integrity and authenticity.</p>
<p>We have successfully verified that the file was signed by Pierr's official Arch
Linux key and has not been tampered with.</p>
<p>The following is only if you currently already have keys on your gpg keyring.</p>
<details>
<summary> ☑️ Click to expand Key Signing and Publishing Example </summary>
<p>List your keys to get the arch keyID:</p>
<pre><code class="language-bash">gpg --list-keys
# ... snip ...
pub   ed25519/0x76A5EF9054449A5C 2022-10-31 [SC] [expires: 2037-10-27]
      Key fingerprint = 3E80 CA1A 8B89 F69C BA57  D98A 76A5 EF90 5444 9A5C
uid                   [  full  ] Pierre Schmitz &lt;pierre@archlinux.org&gt;
uid                   [  full  ] Pierre Schmitz &lt;pierre@archlinux.de&gt;
sub   ed25519/0xD6D13C45BFCFBAFD 2022-10-31 [A] [expires: 2037-10-27]
sub   cv25519/0x7F56ADE50CA3D899 2022-10-31 [E] [expires: 2037-10-27]
</code></pre>
<p>Sign the key:</p>
<pre><code class="language-bash">gpg --sign-key 0x76A5EF9054449A5C
</code></pre>
<p>Now you can export and publish the new public key and send it to a keyserver:</p>
<pre><code class="language-bash">gpg --export --armor 0x76A5EF9054449A5C &gt; archlinux-signed.asc
gpg --send-keys 0x76A5EF9054449A5C
</code></pre>
<p>The more people that verify, sign, and re-export and publish their keys the
better for the web of trust that gpg uses making the network more secure for
everyone.</p>
</details>
</details>
<hr />
<ol>
<li><strong>Connect to Wi-Fi</strong>:</li>
</ol>
<pre><code class="language-bash">iwctl
[iwd]# device list
[iwd]# station wlan0 scan
[iwd]# station wlan0 connect NETGEAR80
# Enter your Password
# Check Connection
[iwd]# station wlan0 show
[iwd]# exit
</code></pre>
<pre><code class="language-bash">ping -c 3 archlinux.org
</code></pre>
<hr />
<ol start="2">
<li><strong>Update package databases and mirrorlist</strong>:</li>
</ol>
<pre><code class="language-bash">pacman -Syyu
</code></pre>
<p>Save a backup of your current mirrorlist so we can safely update it:</p>
<pre><code class="language-bash">cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak
</code></pre>
<pre><code class="language-bash">pacman -S reflector
reflector --list-countries
# Example if you live in the US
reflector -c US --protocol https --age 6 --fastest 5 --sort rate --save /etc/pacman.d/mirrorlist
</code></pre>
<p>This actually improves security by only providing <code>HTTPS</code> mirrors, by default
both HTTP and HTTPS are used.</p>
<p>NOTE: This can take a bit and you can expect some failures..</p>
<hr />
<ol start="3">
<li><strong>Set keyboard layout, font, and system clock</strong>:</li>
</ol>
<p>Default keymap is US, if you need something different:</p>
<pre><code class="language-bash">localectl list-keymaps
loadkeys &lt;chosen-map&gt;
# Increase font size
setfont ter-132b
</code></pre>
<pre><code class="language-bash">timedatectl set-ntp true
timedatectl list-timezones
# Example
sudo timedatectl set-timezone America/New_York
</code></pre>
<hr />
<ol start="4">
<li><strong>Partition your Disk</strong>:</li>
</ol>
<p>The only required partitions are one for the root directory <code>/</code> (typically <code>1G</code>)
and one for booting in UEFI mode, an EFI system partition (typically the rest of
the space left).</p>
<p>In this section, I'll assume that you're starting with a clean slate. If you're
not, you can use your existing partitions if they meet the above requirements or
delete them.</p>
<p>To delete existing partitions with <code>cfdisk</code>, you launch it on the target
filesystem, select the partition you want to delete and Select -&gt; <code>[ Delete ]</code>
until all you see is <code>Free space</code> and a clean slate and <code>[ Write ]</code> &amp; <code>[ Quit ]</code>
to save your changes.</p>
<p>Identify your target disk (e.g., <code>/dev/nvme0n1</code>):</p>
<pre><code class="language-bash">fdisk -l
</code></pre>
<pre><code class="language-bash">cfdisk /dev/nvme0n1
</code></pre>
<ul>
<li>
<p>Select -&gt; <code>[ Free Space ]</code></p>
<ul>
<li>
<p>Select -&gt; <code>[ New ]</code></p>
</li>
<li>
<p>Partition size: <code>1G</code></p>
</li>
<li>
<p>Type -&gt; <code>EFI System</code></p>
</li>
</ul>
</li>
<li>
<p>Select -&gt; <code>[ Free Space ]</code></p>
<ul>
<li>
<p>Partition size: The rest of the space</p>
</li>
<li>
<p>Type -&gt; <code>Linux filesystem</code></p>
</li>
<li>
<p>Select -&gt; <code>[ Write ]</code></p>
</li>
<li>
<p>Select -&gt; <code>[ Quit ]</code></p>
</li>
</ul>
</li>
</ul>
<hr />
<ol start="5">
<li><strong>Format the EFI partition as FAT32</strong>:</li>
</ol>
<pre><code class="language-bash">mkfs.fat -F32 /dev/nvme0n1p1
</code></pre>
<p>Leave the root partition unformatted for the next step.</p>
<hr />
<ol start="6">
<li><strong>Encrypt the Root partition and Open it</strong>:</li>
</ol>
<pre><code class="language-bash">cryptsetup luksFormat /dev/nvme0n1p2
cryptsetup open /dev/nvme0n1p2 cryptroot
</code></pre>
<p>Create a filesystem:</p>
<pre><code class="language-bash">mkfs.btrfs /dev/mapper/cryptroot
</code></pre>
<p>If you mount the filesystem with compression before running <code>genfstab</code>, it will
automatically add the chosen compression to the <code>fstab</code>.</p>
<pre><code class="language-bash">mount /dev/nvme0n1p1 /mnt/boot  # Mount EFI partition at /mnt/boot
mount -o compress=zstd /dev/mapper/cryptroot /mnt
</code></pre>
<hr />
<h2 id="install-the-base-system-on-mnt-with-pacstrap"><a class="header" href="#install-the-base-system-on-mnt-with-pacstrap">Install the Base System on <code>/mnt</code> with <code>pacstrap</code></a></h2>
<p>If you prefer Nvim or a hardened kernel, change it here.</p>
<pre><code class="language-bash">pacstrap -K /mnt base linux-zen linux-zen-headers linux-firmware networkmanager helix lightdm lightdm-gtk-greeter btrfs-progs cryptsetup sudo base-devel efibootmgr systemd-ukify
</code></pre>
<hr />
<ol start="7">
<li><strong>Generate the Filesystem Table</strong>:</li>
</ol>
<p>The EFI and root partitions need to be mounted before you generate the
filesystem table in the next step.</p>
<pre><code class="language-bash">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
#
hx /mnt/etc/fstab
cat /mnt/etc/fstab
</code></pre>
<p>Fix security hole and harden <code>/boot</code> permissions by adding
<code>fmask=0137, dmask=0027</code>:</p>
<pre><code class="language-bash">hx /mnt/etc/fstab
</code></pre>
<p>Example</p>
<pre><code class="language-fstab"># Static information about the filesystems.
# See fstab(5) for details.

# &lt;file system&gt; &lt;dir&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;
# /dev/mapper/cryptroot
UUID=6d68a2bf-34ea-4adc-86d5-cb1d56de44a4	/         	btrfs     	rw,relatime,compress=zstd:3,ssd,space_cache=v2,subvol=/	0 0

# /dev/nvme0n1p1
UUID=B88B-844F      	/boot     	vfat      	rw,relatime,fmask=0137,dmask=0027,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro	0 2
</code></pre>
<pre><code class="language-bash">chmod 700 /boot
chmod 600 /boot/loader/random-seed
</code></pre>
<p><strong>Important</strong>: The <code>fstab</code> should list both partitions, if it doesn't you'll
need to ensure both partitions are mounted and regenerate your fstab again with
<code>genfstab</code>. Also ensure that the root partition was mounted with compression.</p>
<hr />
<ol start="8">
<li><strong>Change Root (<code>chroot</code>) into the New Installation</strong></li>
</ol>
<pre><code class="language-bash">arch-chroot /mnt
</code></pre>
<p>Create a user:</p>
<pre><code class="language-bash">useradd -m -G wheel -s /bin/bash yourusername
passwd yourusername
</code></pre>
<p>Create an admin password:</p>
<pre><code class="language-bash">passwd
</code></pre>
<p>Enable sudo for wheel group:</p>
<p>In <code>/etc/sudoers</code> uncomment the line:</p>
<pre><code class="language-bash">%wheel ALL=(ALL:All) ALL
</code></pre>
<hr />
<ol start="9">
<li>Edit <code>/etc/mkinitcpio.conf</code> in the new system to add an <code>sd-encrypt</code> hook
before the <code>filesystems</code> attribute.</li>
</ol>
<ul>
<li>
<p>Locate the <code>HOOKS</code> line</p>
</li>
<li>
<p>Insert <code>encrypt</code> <strong>before</strong> filesystems</p>
</li>
</ul>
<pre><code class="language-bash">vim /etc/mkinitcpio.conf
</code></pre>
<p>To use <code>sd-encrypt</code>, it is necessary to replace <code>udev</code> with <code>systemd</code> and if you
require a different keyboard layout from US <code>sd-vconsole</code> is needed.</p>
<pre><code class="language-bash"># mkinitcpio.conf
# *IF* you use an nvme drive
MODULES=(nvme)
FILES=(/etc/crypttab.initramfs /etc/vconsole.conf)
# ... snip ...
HOOKS=(base systemd autodetect microcode modconf kms keyboard keymap consolefont sd-vconsole block sd-encrypt filesystems fsck systemd-ukify)
# ... snip ...
</code></pre>
<p>Create <code>/etc/crypttab.initramfs</code>:</p>
<pre><code class="language-initramfs">cryptroot UUID=your-uuid none luks,discard
</code></pre>
<hr />
<p>Create <code>/etc/vconsole.conf</code>:</p>
<p>For example <code>KEYMAP=fr</code> is french</p>
<pre><code class="language-conf">KEYMAP=us
FONT=lat9w-16
</code></pre>
<hr />
<p>Edit <code>/etc/mkinitcpio.d/linux-zen.preset</code>, this enables <code>mkinitcpio -P</code> to
generate a UKI in <code>/boot/EFI/Linux/</code>:</p>
<pre><code class="language-preset"># mkinitcpio preset file for the 'linux-zen' package

ALL_config="/etc/mkinitcpio.conf"
ALL_kver="/boot/vmlinuz-linux-zen"

PRESETS=('default' 'fallback')
# PRESETS=('default')

# default_config="/etc/mkinitcpio.conf"
# default_image="/boot/initramfs-linux-zen.img"
default_uki="/boot/EFI/Linux/arch-linux-zen.efi"
default_options="--splash /usr/share/systemd/bootctl/splash-arch.bmp"

#fallback_config="/etc/mkinitcpio.conf"
#fallback_image="/boot/initramfs-linux-zen-fallback.img"
fallback_uki="/boot/EFI/Linux/arch-linux-zen-fallback.efi"
fallback_options="-S autodetect"
</code></pre>
<p>Generate the initial RAM Filesystem (initramfs) image.</p>
<pre><code class="language-bash">mkinitcpio -P
</code></pre>
<blockquote>
<p>❗️ TIP: If <code>mkinitcpio -P</code> fails, exit <code>arch-chroot</code> and ensure both the boot
&amp; root partitions are mounted. <code>arch-chroot</code> back into <code>/mnt</code> and try again.
Ensure that <code>/boot/EFI/Linux/arch-linux-zen.efi</code> and
<code>/boot/EFI/Linux/arch-linux-zen-fallback.efi</code> exist for your kernel of choice.</p>
</blockquote>
<hr />
<ol start="10">
<li><strong>Install systemd-boot and setup Unified Kernel Image</strong>, (while still in
chroot environment):</li>
</ol>
<p>Ensure your UEFI variables are accessible:</p>
<pre><code class="language-bash">efivar --list
</code></pre>
<p>This command won't work if both partitions aren't mounted, ensure they are both
mounted and if it still doesn't work you can use <code>--esp-path=/boot</code> or
<code>--esp-path=/mnt/boot</code>.</p>
<pre><code class="language-bash">bootctl install
</code></pre>
<p>Edit <code>/etc/kernel/cmdline</code> and add the output of <code>blkid</code> on your root partition.
For example:</p>
<pre><code class="language-bash">blkid /dev/nvme0n1p2 &gt; /tmp/uuid.txt
</code></pre>
<p>When you open <code>/etc/kernel/cmdline</code> in vim or helix, run <code>:r /tmp/uuid.txt</code> to
read the UUID of your root partition into the file. You only need the numbers
like so:</p>
<pre><code class="language-cmdline">rd.luks.name=7b78e942-f4f7-4dde-a015-3a816305483f=cryptroot root=/dev/mapper/cryptroot rw
</code></pre>
<p>In the above example, <code>7b78e942-f4f7-4dde-a015-3a816305483f</code> is the UUID
extracted from the <code>blkid</code> command.</p>
<p>Create a <code>/boot/loader/entries/arch.conf</code> with the following:</p>
<pre><code class="language-conf">title Arch Linux
linux /vmlinuz-linux-zen
initrd /initramfs-linux-zen.img
options rd.luks.name=7b78e942-f4f7-4dde-a015-3a816305483f=cryptroot root=/dev/mapper/cryptroot rw quiet
</code></pre>
<blockquote>
<p>❗️ NOTE: The <code>arch.conf</code> here is redundant because <code>systemd-boot</code> is
configured to autodetect the UKI. It doesn't hurt to add it though and can
prevent issues in the future. Ensure <code>rd.luks.name=</code> contains the UUID from
the encrypted root partition. (e.g., <code>blkid /dev/nvme0n1p2</code>).</p>
</blockquote>
<p>And finally, a <code>/boot/loader/loader.conf</code>:</p>
<pre><code class="language-conf">default arch.conf
# default @saved  # return to last choice
timeout 4
console-mode auto
auto-entries 1
</code></pre>
<pre><code class="language-bash">bootctl status
</code></pre>
<p>Set a password to protect <code>systemd-boot</code> with <code>systemd-boot-password</code>:</p>
<pre><code class="language-bash">paru -S systemd-boot-password
</code></pre>
<pre><code class="language-bash">sudo sbpctl install /boot
</code></pre>
<p>You will now be prompted for your password before you can edit kernel
parameters.</p>
<hr />
<p><strong>systemd-ukify and the Unified Kernel Image</strong>:</p>
<p>We already added <code>systemd-ukify</code> in the pacstrap command, let's add a few more
tools for this process:</p>
<pre><code class="language-bash">sudo pacman -S sbsigntools efitools
</code></pre>
<p>Copy the existing template to <code>/etc/kernel/uki.conf</code>:</p>
<pre><code class="language-bash">cp /usr/lib/kernel/uki.conf /etc/kernel/uki.conf
</code></pre>
<p>Edit <code>/etc/kernel/uki.conf</code>:</p>
<pre><code class="language-conf">[UKI]
#Initrd=
#Microcode=
#Splash=
#PCRPKey=
#PCRBanks=
#SecureBootSigningTool=
SecureBootPrivateKey=/etc/kernel/secure-boot-private-key.pem
SecureBootCertificate=/etc/kernel/secure-boot-certificate.pem
#SecureBootCertificateDir=
#SecureBootCertificateName=
#SecureBootCertificateValidity=
#SigningEngine=
SignKernel=yes
</code></pre>
<p>Generate your signing keys:</p>
<pre><code class="language-bash">ukify genkey --config /etc/kernel/uki.conf
</code></pre>
<p>The above command creates <code>/etc/kernel/secure-boot-certificate.pem</code> and
<code>/etc/kernel/secure-boot-private-key.pem</code>.</p>
<p>Building the UKIs:</p>
<pre><code class="language-bash">mkdir -p /boot/EFI/Linux
mkinitcpio -P
# Output
Wrote signed /boot/EFI/Linux/arch-linux-zen.efi
==&gt; Unified kernel image generation successful
</code></pre>
<p>Sign the boot loader with the new keys:</p>
<pre><code class="language-bash">/usr/lib/systemd/systemd-sbsign sign \
--private-key /etc/kernel/secure-boot-private-key.pem \
--certificate /etc/kernel/secure-boot-certificate.pem \
--output /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed \
/usr/lib/systemd/boot/efi/systemd-bootx64.efi
</code></pre>
<p>Output:</p>
<pre><code class="language-text">Wrote signed PE binary to /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed
</code></pre>
<pre><code class="language-bash">sudo bootctl install --secure-boot-auto-enroll yes \
--certificate /etc/kernel/secure-boot-certificate.pem \
--private-key /etc/kernel/secure-boot-private-key.pem
</code></pre>
<p>Output:</p>
<pre><code class="language-text">Copied "/usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed" to "/boot/EFI/systemd/systemd-bootx64.efi".
    3 Copied "/usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed" to "/boot/EFI/BOOT/BOOTX64.EFI".
    4 ⚠️  Mount point '/boot' which backs the random seed file is world accessible, which is a security hole!  ⚠️
    5 ⚠️ Random seed file '/boot/loader/random-seed' is world accessible, which is a security hole! ⚠️
    6 Random seed file /boot/loader/random-seed successfully refreshed (32 bytes).
    7 Secure boot auto-enrollment file /boot/loader/keys/auto/PK.auth successfully written.
    8 Secure boot auto-enrollment file /boot/loader/keys/auto/KEK.auth successfully written.
    9 Secure boot auto-enrollment file /boot/loader/keys/auto/db.auth successfully written.
   10 Created EFI boot entry "Linux Boot Manager".
</code></pre>
<p>Fix the security hole:</p>
<pre><code class="language-bash">chmod 700 /boot
</code></pre>
<p>Add the following to your <code>/boot/loader/loader.conf</code>:</p>
<pre><code class="language-conf">secure-boot-enroll force
</code></pre>
<p>Reboot into setup-mode and it will start an automatic countdown where it enrolls
your keys when the time runs out.</p>
<p>After successful key enrollment, reboot into UEFI again, enable Secure Boot and
reboot.</p>
<p>When the desktop launches, check the output of <code>bootctl status</code> to ensure
<code>Secure Boot: enabled (user)</code></p>
<p>If your system doesn't accept them, you may have to do some conversions. You can
also add the keys manually which is what I did.</p>
<details>
<summary> ✔️ Click to Expand conversion Examples </summary>
<pre><code class="language-bash"># Create workspace for certs and outputs
mkdir -p ~/secureboot/output

# Define certificate location
CERT_PEM="/etc/kernel/secure-boot-certificate.pem"

# Convert PEM cert to DER format for UEFI enrollment
sudo openssl x509 -in $CERT_PEM -out ~/secureboot/output/db.cer -outform DER

# Convert PEM cert to EFI Signature List
cert-to-efi-sig-list $CERT_PEM ~/secureboot/output/db.esl

# Sign the Signature List (run from wherever your private key is; do not copy it)
sudo sign-efi-sig-list -k /etc/kernel/secure-boot-private-key.pem -c $CERT_PEM db \
    ~/secureboot/output/db.esl ~/secureboot/output/db.auth
</code></pre>
<p>Manual Key Enrollment:</p>
<ul>
<li>
<p><code>db.cer</code> -&gt; enroll in db (Trusted Signatures), Choose the desired drive, find
the file and add it. Save as an <code>Authorized Signature</code> instead of <code>Public Key</code></p>
</li>
<li>
<p><code>PK.cer</code> -&gt; enroll in <code>Platform Key</code>(PK)</p>
</li>
<li>
<p>Keep your <code>secure-boot-private-key.pem</code> <strong>private</strong>, with the above commands
we only use it when signing, and otherwise keep it protected.</p>
</li>
</ul>
</details>
<hr />
<ol start="11">
<li><strong>Enable LightDM and NetworkManager</strong></li>
</ol>
<pre><code class="language-bash">systemctl enable lightdm
systemctl enable NetworkManager
</code></pre>
<blockquote>
<p>❗️ NOTE: If you're ever unable to run the above commands in the chroot
environment, exit chroot and run:</p>
<pre><code class="language-bash">systemctl --root=/mnt enable lightdm
systemctl --root=/mnt enable NetworkManager
</code></pre>
</blockquote>
<p>Configure LightDM greeter, edit <code>/etc/lightdm/lightdm.conf</code> to add:</p>
<pre><code class="language-conf"># lightdm.conf
[Seat:*]
greeter-session=lightdm-gtk-greeter
</code></pre>
<p>Exit <code>arch-chroot</code> with <code>exit</code></p>
<p>Unmount your partitions and reboot:</p>
<pre><code class="language-bash">umount /mnt/boot
umount /mnt
cryptsetup close cryptroot
</code></pre>
<hr />
<ol start="12">
<li><strong>Reboot</strong></li>
</ol>
<pre><code class="language-bash">bootctl status
System:
      Firmware: UEFI 2.70 (American Megatrends)
 Firmware Arch: x64
   Secure Boot: enabled (user)
  TPM2 Support: yes
  Measured UKI: yes
  Boot into FW: supported
</code></pre>
<hr />
<h3 id="creating-a-readonly-snapshot-of-your-root-subvolume"><a class="header" href="#creating-a-readonly-snapshot-of-your-root-subvolume">Creating a readonly snapshot of your root subvolume:</a></h3>
<ul>
<li><a href="https://wiki.archlinux.org/title/System_backup">Arch Wiki System Backup</a></li>
</ul>
<details>
<summary> ✔️ Click to Expand snapshot & Backup Example </summary>
<ol>
<li>Create readonly snapshot of root subvol:</li>
</ol>
<pre><code class="language-bash">sudo btrfs subvolume snapshot -r / /root-snapshot-$(date +%Y%m%d%H%M%S)
</code></pre>
<ol start="2">
<li>Mount your external backup disk:</li>
</ol>
<pre><code class="language-bash">sudo mkdir -p /mnt/backup
sudo mount /dev/sdc1 /mnt/backup
</code></pre>
<ol start="3">
<li>Use rsync to copy the snapshot to the external drive:</li>
</ol>
<p>List the available snapshots and get the exact name:</p>
<pre><code class="language-bash">sudo btrfs subvolume list /
</code></pre>
<pre><code class="language-bash">sudo rsync -aAXv --delete --progress /root-snapshot-20251002135000/ /mnt/backup/root-backup/
</code></pre>
<ol start="4">
<li>Unmount the external drive:</li>
</ol>
<pre><code class="language-bash">sudo umount /mnt/backup
</code></pre>
<ol start="5">
<li>Optionally, delete older snapshots to save space:</li>
</ol>
<pre><code class="language-bash">sudo btrfs subvolume delete /root-snapshot-OLD_TIMESTAMP
</code></pre>
<h3 id="restoring-from-a-backup"><a class="header" href="#restoring-from-a-backup">Restoring from a Backup</a></h3>
<p>For this, you mount the partitions but don't need to <code>arch-chroot</code> in.</p>
<ol>
<li>
<p>Boot from a live USB</p>
</li>
<li>
<p>Mount your encrypted root partition (unlock if encrypted) and the external
backup drive.</p>
</li>
<li>
<p>Move or delete the corrupted data on the root partition.</p>
</li>
<li>
<p>Use rsync to copy the backed-up snapshot from the external disk back to the
root partition, preserving permissions and attributes.</p>
</li>
</ol>
<pre><code class="language-bash">sudo rsync -aAXv --delete /mnt/backup/root-backup/ /
</code></pre>
<p>Or, the Wiki's suggestion, (Much more efficient, Direct backup of a running
system without the need for btrfs snapshots):</p>
<pre><code class="language-bash">sudo rsync -aAXHv --exclude='/dev/*' --exclude='/proc/*' --exclude='/sys/*' --exclude='/tmp/*' --exclude='/run/*' --exclude='/mnt/*' --exclude='/media/*' --exclude='/lost+found/' / /path/to/backup
</code></pre>
<ul>
<li>
<p><code>/mnt/backup/root-backup/</code> is the path where the backup snapshot is mounted on
the external disk.</p>
</li>
<li>
<p><code>/</code> is the root partition mount point where you want to restore the files.</p>
</li>
<li>
<p>The options:</p>
<ul>
<li>
<p><code>-a</code> archive mode to preserve symbolic links, permissions, timestamps, etc.</p>
</li>
<li>
<p><code>-A</code> preserve ACLs (access control lists).</p>
</li>
<li>
<p><code>-X</code> preserve extended attributes.</p>
</li>
<li>
<p><code>-v</code> verbose output.</p>
</li>
<li>
<p><code>--delete</code> deletes files on the destination that don't exist in the source,
keeping an exact mirror.</p>
</li>
</ul>
</li>
</ul>
<p>If you want to restore a specific snapshot directory (e.g.,
<code>/root-snapshot-20251002135000</code>), replace the source path accordingly, like:</p>
<pre><code class="language-bash">sudo rsync -aAXv --delete /mnt/backup/root-snapshot-20251002135000/ /
</code></pre>
<ul>
<li><a href="https://wiki.archlinux.org/title/Rsync#As_a_backup_utility">Arch Wiki rsync</a></li>
</ul>
<ol start="5">
<li>
<p>Reinstall the bootloader if necessary.</p>
</li>
<li>
<p>Unmount everything and reboot.</p>
</li>
</ol>
<h3 id="automated-backup"><a class="header" href="#automated-backup">Automated backup</a></h3>
<p>Create <code>/etc/cron.daily/backup</code>:</p>
<pre><code class="language-backup">#!/bin/sh
rsync -a --delete --quiet /path/to/backup /location/of/backup
</code></pre>
<p>Change <code>/path/to/backup</code> to what needs to be backed-up such as <code>/home</code> or <code>/</code></p>
</details>
<hr />
<h3 id="arch-chroot"><a class="header" href="#arch-chroot">arch-chroot</a></h3>
<details>
<summary>  ✔️ Click to Expand `arch-chroot` Example </summary>
<p>Say you forgot something, like forgetting to add a user and password. You reboot
and go to TTY into your system and are hit with a AHHH I can't log in WTF!</p>
<p>It's as easy as repeating some of the steps above. Reboot into the Live
environment, remount your partitions and <code>arch-chroot</code> back in:</p>
<p>Open the encrypted root partition:</p>
<pre><code class="language-bash">cryptsetup open /dev/nvme0n1p2 cryptroot
</code></pre>
<p>Mount the decrypted root:</p>
<pre><code class="language-bash">mount /dev/mapper/cryptroot /mnt
</code></pre>
<p>Mount the EFI partition:</p>
<pre><code class="language-bash">mount /dev/nvme0n1p1 /mnt/boot
</code></pre>
<p>Chroot into your installed system:</p>
<pre><code class="language-bash">arch-chroot /mnt
</code></pre>
<pre><code class="language-bash">useradd -m -G wheel -s /bin/bash yourusername passwd yourusername
</code></pre>
<ul>
<li>The <code>-s /bin/bash</code> sets your default shell, you can use zsh if you have it
installed.</li>
</ul>
<p>Uncomment the line <code>%wheel ALL=(ALL:All) ALL</code> in <code>/etc/sudoers</code></p>
<p>Exit chroot:</p>
<pre><code class="language-bash">exit
</code></pre>
<p>Unmount and close LUKS:</p>
<pre><code class="language-bash">umount /mnt/boot
umount /mnt
cryptsetup close cryptroot
reboot
</code></pre>
<h3 id="resources"><a class="header" href="#resources">Resources</a></h3>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/title/Installation_guide">Arch Wiki Installation Guide</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot">Arch Wiki UKI/SecureBoot</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Unified_kernel_image">Wiki UKI</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Systemd-boot">Wiki systemd-boot</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/RethinkDNS_Guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../arch/enc_dns.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/RethinkDNS_Guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../arch/enc_dns.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
